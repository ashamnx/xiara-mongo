{"version":3,"sources":["../source/Definitions/MongoSchema.ts"],"names":[],"mappings":"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","file":"MongoSchema.js","sourcesContent":["import { Db, ObjectId, Collection, CollectionCreateOptions } from \"mongodb\";\nimport { SchemaValidator, SchemaValidationResult } from \"./Schema\";\nimport { MongoCollection, ICollection } from \"./MongoCollection\";\n\nexport interface IPropertyOptions\n{\n\tname?: string; // Name of the property\n\trequired?: boolean; // Is the property required?\n\tunique?: boolean; // Is the field unique?\n\thidden?: boolean; // Should the field visible when converted toJSON?\n\tindex?: -1 | 0 | 1; // Is the field indexed?\n\treference?: typeof MongoCollection; // Populate this field with another field (ObjectId)\n\tby?: string; // Reference from the other collection by this field\n\tautoPopulate?: boolean;\n\tdefault?: any; // default value\n\ttype?: any; // Type of the field (Override)\n};\n\nexport interface IPropertyIndex\n{\n\tspecification: object;\n\tunique: boolean,\n};\n\n\nexport interface IProperty\n{\n\tname: string;\n\ttype: any;\n\toptions: IPropertyOptions;\n};\n\nexport interface IModelOptions\n{\n\tindexes?: IPropertyIndex[];\n\tinherits?: any[]\n}\n\nexport class MongoSchema\n{\n\tpublic name: string;\n\tpublic indexes: IPropertyIndex[] = [];\n\tpublic fields: IProperty[] = [];\n\tprotected  DB: Db;\n\tpublic createOptions: CollectionCreateOptions;\n\tpublic hooks: any = {};\n\tpublic inherits: typeof MongoCollection[] = [];\n\n\tconstructor(public CollectionSpec: any)\n\t{\n\t//\tthis.addField(\"_id\", ObjectId, {});\n\n\t\t// this.addField(\"_version\", Number, {\n\t\t// \tdefault: 0,\n\t\t// });\n\t}\n\n\taddField(fieldName: string, fieldType: any, fieldOptions: IPropertyOptions)\n\t{\n\t\tif(fieldOptions.index !== undefined || fieldOptions.unique !== undefined )\n\t\t{\n\t\t\tvar index: IPropertyIndex = {\n\t\t\t\tspecification: {},\n\t\t\t\tunique: fieldOptions.unique,\n\t\t\t};\n\t\t\tindex.specification[fieldName] = fieldOptions.index || 1;\n\t\t\tthis.addIndex(index);\n\t\t}\n\n\t\tif(fieldOptions.type !== undefined)\n\t\t{\n\t\t\tfieldType = fieldOptions.type;\n\t\t}\n\n\t\tthis.fields.push({\n\t\t\tname: fieldName,\n\t\t\ttype: fieldType.name,\n\t\t\toptions: fieldOptions,\n\t\t});\n\t}\n\n\tgetHiddenFields()\n\t{\n\t\treturn this.callHook(\"fields:hidden\", this.fields.filter( field => field.options.hidden));\n\t}\n\n\tgetVisibleFields()\n\t{\n\t\treturn this.callHook(\"fields:visible\", this.fields.filter( field => !field.options.hidden ));\n\t}\n\n\taddIndex(index: IPropertyIndex)\n\t{\n\t\tthis.indexes.push(index);\n\t}\n\n\tsetConnection(db: Db)\n\t{\n\t\tthis.DB = db;\n\t\tthis.callHook(\"db:connected\");\n\t}\n\n\tfindField(name: string)\n\t{\n\t\treturn this.fields.find( field => {\n\t\t\tif(field.name == name)\n\t\t\t\treturn true;\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tprepare()\n\t{\n\t\t\n\t\tfor(let inherited of this.inherits)\n\t\t{\n\t\t\tlet inheritedSchema:MongoSchema = inherited.getSchema();\n\t\t\tfor(let inheritedField of inheritedSchema.fields)\n\t\t\t{\n\t\t\t\t// Skip fields. We allow overrides this way?\n\t\t\t\tif(this.findField(inheritedField.name))\n\t\t\t\t\tcontinue;\n\n\t\t\t\tthis.fields.unshift(inheritedField);\n\t\t\t}\n\t\t}\n\t}\n\n\tcollection(): Collection<any>\n\t{\n\t\treturn this.DB.collection(this.name);\n\t}\n\n\tcreateCollection()\n\t{\n\t\tthis.DB.createCollection(this.name, this.createOptions).then( result => {\n\t\t\tthis.callHook(\"collection:created\");\n\t\t\tfor(let index of this.indexes)\n\t\t\t{\n\t\t\t\tthis.collection().createIndex(index.specification, {\n\t\t\t\t\tunique: index.unique,\n\t\t\t\t\tdropDups: true,\n\t\t\t\t\tw: 1\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.callHook(\"indexes:created\");\n\t\t});\n\t}\n\n\tregisterHook(hookName: string, callback: any)\n\t{\n\t\tthis.hooks[hookName] = callback;\n\t}\n\n\tcallHook(hookName: string, input?: any)\n\t{\n\t\tif(this.hooks[hookName])\n\t\t{\n\t\t\treturn this.hooks[hookName](input);\n\t\t}\n\t\treturn input;\n\t}\n\n\tvalidate(document: object): SchemaValidationResult\n\t{\n\t\tlet validatingDocument = this.callHook(\"validate\", document);\n\t\t\n\t\tfor(var field of this.fields)\n\t\t{\n\t\t\tvar error = SchemaValidator.validateField(field, validatingDocument[field.name]);\n\t\t\tif(error)\n\t\t\t{\n\t\t\t\treturn error;\n\t\t\t}\n\t\t}\n\t\t\n\t\t//SchemaValidator.ValidateDocument(document, this);\n\t}\n\n};"]}