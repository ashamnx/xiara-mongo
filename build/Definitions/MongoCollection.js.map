{"version":3,"sources":["../source/Definitions/MongoCollection.ts"],"names":[],"mappings":";;;;;;;;;;;AAEA,2CAAwC;AACxC,iCAAwE;AACxE,mCAAqU;AACrU,sCAAsC;AACtC,6DAA4D;AAC5D,6BAAgC;AAI/B,CAAC;AAEF;IAKC,mBAAmB;IAEnB,yBAAY,IAAgB;QAAhB,qBAAA,EAAA,WAAgB;QAE3B,EAAE,CAAA,CAAC,IAAI,IAAI,IAAI,CAAC,CAChB,CAAC;YACA,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACpB,CAAC;IACF,CAAC;IAEM,mCAAmB,GAA1B,UAA8B,IAAiB;QAE9C,MAAM,CAAC,IAAI,IAAI,EAAE,CAAC;IACnB,CAAC;IAED,iCAAO,GAAP,UAAQ,IAAS;QAEhB,EAAE,CAAA,CAAC,CAAC,IAAI,CAAC;YACR,MAAM,CAAC;QAER,IAAI,MAAM,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACxC,GAAG,CAAA,CAAc,UAAa,EAAb,KAAA,MAAM,CAAC,MAAM,EAAb,cAAa,EAAb,IAAa;YAA1B,IAAI,KAAK,SAAA;YAEZ,EAAE,CAAA,CAAC,KAAK,CAAC,OAAO,CAAC,CACjB,CAAC;gBACA,EAAE,CAAA,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,SAAS,IAAI,KAAK,CAAC,OAAO,CAAC,OAAO,KAAK,SAAS,CAAC,CACzE,CAAC;oBACA,EAAE,CAAA,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,IAAI,MAAM,CAAC,CACxC,CAAC;wBACA,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,IAAI,KAAK,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;wBAC/C,QAAQ,CAAC;oBACV,CAAC;oBAED,EAAE,CAAA,CAAC,OAAO,KAAK,CAAC,OAAO,CAAC,OAAO,KAAK,UAAU,CAAC,CAC/C,CAAC;wBACA,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;wBAC3C,QAAQ,CAAC;oBACV,CAAC;oBACD,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC;oBACzC,QAAQ,CAAC;gBACV,CAAC;gBACD,OAAO,CAAC,GAAG,CAAC,OAAO,GAAC,KAAK,CAAC,IAAI,GAAC,GAAG,EAAE,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;gBACtD,EAAE,CAAA,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,SAAS,IAAI,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,QAAQ,CAAC,CACvF,CAAC;oBACA,OAAO,CAAC,GAAG,CAAC,YAAY,EAAE,KAAK,CAAC,IAAI,EAAE,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;oBAC/D,IAAI,oBAAoB,GAAG,IAAI,KAAK,CAAC,OAAO,CAAC,SAAS,EAAE,CAAC;oBACzD,oBAAoB,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;oBAC/C,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,oBAAoB,CAAC;oBACxC,QAAQ,CAAC;gBACV,CAAC;YACF,CAAC;YACD,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;SACpC;IACF,CAAC;IAED,mCAAS,GAAT,UAAU,MAAmB;QAE5B,IAAI,OAAO,GAAG,EAAE,CAAC;QACjB,GAAG,CAAA,CAAc,UAAM,EAAN,iBAAM,EAAN,oBAAM,EAAN,IAAM;YAAnB,IAAI,KAAK,eAAA;YAEZ,EAAE,CAAA,CAAC,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC,CAC3B,CAAC;gBACA,EAAE,CAAA,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,SAAS,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,IAAI,CAAC;oBAC9D,QAAQ,CAAC;gBAEV,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,IAAI,KAAK,CAAC,CAAC;gBAClE,QAAQ,CAAC;YACV,CAAC;YAED,EAAE,CAAA,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,SAAS,IAAK,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,IAAI,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,OAAO,KAAK,SAAS,CAAC,CACzG,CAAC;gBACA,EAAE,CAAA,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,IAAI,MAAM,CAAC,CACxC,CAAC;oBACA,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,IAAI,KAAK,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;oBAClD,QAAQ,CAAC;gBACV,CAAC;gBAED,EAAE,CAAA,CAAC,OAAO,KAAK,CAAC,OAAO,CAAC,OAAO,KAAK,UAAU,CAAC,CAC/C,CAAC;oBACA,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;oBAC9C,QAAQ,CAAC;gBACV,CAAC;gBAAA,IAAI,CAAA,CAAC;oBACL,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC;gBAC7C,CAAC;YACF,CAAC;YAAA,IAAI,CAAA,CAAC;gBACL,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YACxC,CAAC;SAED;QACD,MAAM,CAAC,OAAO,CAAC;IAChB,CAAC;IAED,kCAAQ,GAAR;QAEC,IAAI,MAAM,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACxC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;IACtC,CAAC;IAED,gDAAgD;IAChD,gCAAM,GAAN;QAEC,IAAI,MAAM,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACxC,MAAM,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,gBAAgB,EAAE,CAAC,CAAC;IAClD,CAAC;IAED,4CAAkB,GAAlB;QAEC,IAAI,MAAM,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACxC,IAAI,UAAU,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;QACrC,IAAI,IAAI,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;QAC3B,IAAI,gBAAgB,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QAC7C,EAAE,CAAA,CAAC,CAAC,gBAAgB,CAAC,CACrB,CAAC;YACA,MAAM,CAAC,IAAI,CAAC;QACb,CAAC;QACD,MAAM,CAAC,IAAI,CAAC;IACb,CAAC;IAEc,6BAAa,GAA5B,UAA6B,KAAU;QAEtC,EAAE,CAAA,CAAC,KAAK,IAAI,KAAK,CAAC,GAAG,IAAI,OAAO,KAAK,CAAC,GAAG,KAAK,QAAQ,CAAC,CACvD,CAAC;YACA,KAAK,CAAC,GAAG,GAAG,IAAI,eAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QACrC,CAAC;IACF,CAAC;IAEM,qBAAK,GAAZ,UAAwC,KAAc;QAErD,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrC,MAAM,CAAC,IAAI,kBAAU,CAAI,IAAI,EAAE,KAAK,CAAC,CAAC;IACvC,CAAC;IAEM,oBAAI,GAAX,UAAuC,KAAc;QAEpD,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrC,MAAM,CAAC,IAAI,uBAAe,CAAI,IAAI,EAAE,KAAK,CAAC,CAAC;IAC5C,CAAC;IAEM,uBAAO,GAAd,UAA0C,KAAc;QAEvD,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrC,MAAM,CAAC,IAAI,wBAAgB,CAAI,IAAI,EAAE,KAAK,CAAC,CAAC;IAC7C,CAAC;IAEM,yBAAS,GAAhB,UAA4C,IAAa;QAExD,IAAI,QAAQ,GAAM,IAAI,CAAC,mBAAmB,CAAS,IAAI,CAAC,CAAC;QACzD,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACvB,MAAM,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;IACxB,CAAC;IAEM,gCAAgB,GAAvB,UAAmD,KAAc,EAAE,IAAa,EAAE,OAA4C;QAA5C,wBAAA,EAAA,mBAA4C;QAE7H,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrC,IAAI,UAAU,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC,UAAU,EAAE,CAAC;QAC/C,MAAM,CAAC,UAAU,CAAC,gBAAgB,CAAC,KAAK,EAAE;YACzC,IAAI,EAAE,IAAI;SACV,EAAE,OAAO,CAAC,CAAC,IAAI,CAAE,UAAA,MAAM;YACvB,EAAE,CAAA,CAAC,OAAO,IAAI,OAAO,CAAC,cAAc,CAAC,CACrC,CAAC;gBACA,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC;YACrB,CAAC;YACD,MAAM,CAAC,MAAM,CAAC;QACf,CAAC,CAAC,CAAC,KAAK,CAAE,UAAA,KAAK;YACd,MAAM,CAAC,KAAK,CAAC;QACd,CAAC,CAAC,CAAA;IACH,CAAC;IAEM,yBAAS,GAAhB,UAA4C,KAAc,EAAE,IAAa,EAAE,OAAsC;QAAtC,wBAAA,EAAA,mBAAsC;QAEhH,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrC,IAAI,UAAU,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC,UAAU,EAAE,CAAC;QAC/C,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,KAAK,EAAE;YAClC,IAAI,EAAE,IAAI;SACV,EAAE,OAAO,CAAC,CAAC;IACb,CAAC;IAEM,sBAAM,GAAb,UAAyC,KAAc,EAAE,IAAa,EAAE,OAA4D;QAA5D,wBAAA,EAAA,mBAA4D;QAEnI,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrC,IAAI,UAAU,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC,UAAU,EAAE,CAAC;QAC/C,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,KAAK,EAAE;YAC/B,IAAI,EAAE,IAAI;SACV,EAAE,OAAO,CAAC,CAAC;IACb,CAAC;IAEM,sBAAM,GAAb,UAAc,KAAa;QAE1B,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrC,IAAK,UAAU,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC,UAAU,EAAE,CAAC;QAChD,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;IACjC,CAAC;IAEM,yBAAS,GAAhB,UAAiB,KAAa;QAE7B,eAAe,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QACrC,IAAK,UAAU,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC,UAAU,EAAE,CAAC;QAChD,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,KAAK,EAAE,EAAC,MAAM,EAAE,IAAI,EAAC,CAAC,CAAC;IACjD,CAAC;IAEM,yBAAS,GAAhB,UAA4C,QAAmB;QAAnB,yBAAA,EAAA,aAAmB;QAE9D,MAAM,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;IACjD,CAAC;IAEM,yBAAS,GAAhB;QAEC,MAAM,CAAC,yCAAmB,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACjD,CAAC;IAEM,6BAAa,GAApB;QAEC,MAAM,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,UAAU,EAAE,CAAC;IACtC,CAAC;IAEM,qBAAK,GAAZ;QAEC,MAAM,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,KAAK,EAAE,CAAC;IACrC,CAAC;IAED,oCAAU,GAAV;QAEC,MAAM,CAAC,IAAI,CAAC,mBAAmB,EAAE,CAAC,UAAU,EAAE,CAAC;IAChD,CAAC;IAED,6CAAmB,GAAnB;QAEC,MAAM,CAAC,yCAAmB,CAAC,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAC5D,kDAAkD;IACnD,CAAC;IAED,8BAAI,GAAJ,UAAK,OAAiB;QAAjB,wBAAA,EAAA,YAAiB;QAErB,EAAE,CAAA,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CACb,CAAC;YACA,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;QAC7B,CAAC;QAAA,IAAI,CAAA,CAAC;YACL,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;QAC7B,CAAC;IACF,CAAC;IAED,gCAAM,GAAN,UAAO,OAA+C;QAAtD,iBAeC;QAfM,wBAAA,EAAA,mBAA+C;QAErD,IAAI,MAAM,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACxC,IAAI,UAAU,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;QACrC,IAAI,IAAI,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;QAC3B,IAAI,gBAAgB,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QAC7C,EAAE,CAAA,CAAC,CAAC,gBAAgB,CAAC,CACrB,CAAC;YACA,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC,IAAI,CAAE,UAAA,MAAM;gBACtD,KAAI,CAAC,GAAG,GAAG,MAAM,CAAC,UAAU,CAAC,CAAC,sBAAsB;gBACpD,OAAO,CAAC,GAAG,CAAC,iBAAiB,EAAE,KAAI,CAAC,GAAG,CAAC,CAAC;gBACzC,MAAM,CAAC,KAAI,CAAC;YACb,CAAC,CAAC,CAAC;QACJ,CAAC;QACD,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC;IACzC,CAAC;IAED,gCAAM,GAAN,UAAO,OAAsC;QAA7C,iBAiBC;QAjBM,wBAAA,EAAA,mBAAsC;QAE5C,IAAI,MAAM,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACxC,IAAI,UAAU,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;QACrC,IAAI,IAAI,GAAG,IAAI,CAAC,QAAQ,EAAE,CAAC;QAC3B,IAAI,gBAAgB,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QAC7C,EAAE,CAAA,CAAC,CAAC,gBAAgB,CAAC,CACrB,CAAC;YACA,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC;gBAC3B,GAAG,EAAE,IAAI,CAAC,GAAG;aACb,EAAE;gBACF,IAAI,EAAE,IAAI;aACV,EAAE,OAAO,CAAC,CAAC,IAAI,CAAE,UAAA,MAAM;gBACvB,MAAM,CAAC,KAAI,CAAC;YACb,CAAC,CAAC,CAAC;QACJ,CAAC;QACD,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC;IACzC,CAAC;IAED,gCAAM,GAAN;QAEC,EAAE,CAAA,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CACb,CAAC;YACA,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC;QAC7C,CAAC;QAED,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE,CAAC,SAAS,CAAC;YAClC,GAAG,EAAE,IAAI,CAAC,GAAG;SACb,CAAC,CAAC;IACJ,CAAC;IAED,iCAAO,GAAP,UAAQ,WAA4B;QAEnC,IAAI,MAAM,GAAG,WAAW,CAAC,mBAAmB,EAAE,CAAC;QAC/C,IAAI,UAAU,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;QACrC,IAAI,IAAI,GAAG,WAAW,CAAC,QAAQ,EAAE,CAAC;QAClC,IAAI,gBAAgB,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QAC7C,EAAE,CAAA,CAAC,CAAC,gBAAgB,CAAC,CACrB,CAAC;YACA,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE,CAAC,UAAU,CAAC,EAAE,GAAG,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;QAC9D,CAAC;QACD,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC;IACzC,CAAC;IA7SD;QADC,qBAAQ,EAAE;kCACN,kBAAQ;gDAAC;IA8Sf,sBAAC;CAlTD,AAkTC,IAAA;AAlTY,0CAAe;AAkT3B,CAAC","file":"MongoCollection.js","sourcesContent":["import { MongoAdapter } from \"../MongoAdapter\";\r\nimport { MongoSchema, IProperty } from \"./MongoSchema\";\r\nimport { Property } from \"./Decorators\";\r\nimport { MongoQuery, MongoQueryMulti, MongoQuerySingle } from \"./Query\";\r\nimport { Db, Collection, Cursor, AggregationCursor, ObjectId, WriteOpResult, InsertOneWriteOpResult, UpdateWriteOpResult, CollectionInsertOneOptions, ReplaceOneOptions, DeleteWriteOpResultObject, ReplaceWriteOpResult, InsertWriteOpResult, CollStats, FindOneAndReplaceOption, FindAndModifyWriteOpResultObject } from \"mongodb\";\r\n//import { IFindQuery } \"./FindQuery\";\r\nimport { MongoSchemaRegistry } from \"./MongoSchemaRegistry\";\r\nimport { ObjectID } from \"bson\";\r\nexport interface ICollection\r\n{\r\n\tgetSchemaDefinition(): MongoSchema;\r\n};\r\n\r\nexport class MongoCollection implements ICollection\r\n{\r\n\r\n\t@Property()\r\n\t_id: ObjectId;\r\n\t//_version: number;\r\n\r\n\tconstructor(data: any = null)\r\n\t{\r\n\t\tif(data != null)\r\n\t\t{\r\n\t\t\tthis.hydrate(data);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic constructCollection<T>(type: new () => T): T\r\n\t{\r\n\t\treturn new type();\r\n\t}\r\n\r\n\thydrate(data: any)\r\n\t{\r\n\t\tif(!data)\r\n\t\t\treturn;\r\n\t\t\t\r\n\t\tlet schema = this.getSchemaDefinition();\r\n\t\tfor(let field of schema.fields)\r\n\t\t{\r\n\t\t\tif(field.options)\r\n\t\t\t{\r\n\t\t\t\tif(data[field.name] === undefined && field.options.default !== undefined)\r\n\t\t\t\t{\r\n\t\t\t\t\tif(field.options.default.name == \"Date\")\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis[field.name] = new field.options.default();\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif(typeof field.options.default === \"function\")\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis[field.name] = field.options.default();\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis[field.name] = field.options.default;\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\tconsole.log(\"data[\"+field.name+\"]\", data[field.name]);\r\n\t\t\t\tif(data[field.name] && field.options.reference && typeof data[field.name] === \"object\")\r\n\t\t\t\t{\r\n\t\t\t\t\tconsole.log(\"hydrating:\", field.name, typeof data[field.name]);\r\n\t\t\t\t\tlet referencedCollection = new field.options.reference();\r\n\t\t\t\t\treferencedCollection.hydrate(data[field.name]);\r\n\t\t\t\t\tthis[field.name] = referencedCollection;\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis[field.name] = data[field.name];\r\n\t\t}\r\n\t}\r\n\r\n\tdehydrate(fields: IProperty[]): object\r\n\t{\r\n\t\tlet rawData = {};\r\n\t\tfor(let field of fields)\r\n\t\t{\r\n\t\t\tif(field.options.reference)\r\n\t\t\t{\r\n\t\t\t\tif(this[field.name] === undefined || this[field.name] === null)\r\n\t\t\t\t\tcontinue;\t\r\n\t\t\t\t\r\n\t\t\t\trawData[field.name] = this[field.name][field.options.by || \"_id\"];\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif((this[field.name] === undefined  || this[field.name] === null) && field.options.default !== undefined)\r\n\t\t\t{\r\n\t\t\t\tif(field.options.default.name == \"Date\")\r\n\t\t\t\t{\r\n\t\t\t\t\trawData[field.name] = new field.options.default();\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(typeof field.options.default === \"function\")\r\n\t\t\t\t{\r\n\t\t\t\t\trawData[field.name] = field.options.default();\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}else{\r\n\t\t\t\t\trawData[field.name] = field.options.default;\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\trawData[field.name] = this[field.name];\r\n\t\t\t}\r\n\t\t\t\r\n\t\t}\r\n\t\treturn rawData;\r\n\t}\r\n\r\n\ttoObject(): object\r\n\t{\r\n\t\tlet schema = this.getSchemaDefinition();\r\n\t\treturn this.dehydrate(schema.fields);\r\n\t}\r\n\r\n\t// Same as dehydrate but drops the hidden fields\r\n\ttoJSON()\r\n\t{\r\n\t\tlet schema = this.getSchemaDefinition();\r\n\t\treturn this.dehydrate(schema.getVisibleFields());\r\n\t}\r\n\r\n\tgetValidatedObject(): object\r\n\t{\r\n\t\tlet schema = this.getSchemaDefinition();\r\n\t\tlet collection = schema.collection();\r\n\t\tlet data = this.toObject();\r\n\t\tlet validationResult = schema.validate(data);\r\n\t\tif(!validationResult)\r\n\t\t{\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tprivate static sanitizeQuery(query: any)\r\n\t{\r\n\t\tif(query && query._id && typeof query._id === \"string\")\r\n\t\t{\r\n\t\t\tquery._id = new ObjectID(query._id);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic query<T extends MongoCollection>(query?: Object): MongoQuery< T >\r\n\t{\r\n\t\tMongoCollection.sanitizeQuery(query);\r\n\t\treturn new MongoQuery<T>(this, query);\r\n\t}\r\n\r\n\tstatic find<T extends MongoCollection>(query?: Object): MongoQueryMulti< T >\r\n\t{\r\n\t\tMongoCollection.sanitizeQuery(query);\r\n\t\treturn new MongoQueryMulti<T>(this, query);\r\n\t}\r\n\t\r\n\tstatic findOne<T extends MongoCollection>(query?: Object): MongoQuerySingle< T >\r\n\t{\r\n\t\tMongoCollection.sanitizeQuery(query);\r\n\t\treturn new MongoQuerySingle<T>(this, query);\r\n\t}\r\n\r\n\tstatic createOne<T extends MongoCollection>(data?: Object): Promise< T >\r\n\t{\r\n\t\tlet instance: T = this.constructCollection<T>(<any>this);\r\n\t\tinstance.hydrate(data);\r\n\t\treturn instance.save();\r\n\t}\r\n\r\n\tstatic findOneAndUpdate<T extends MongoCollection>(query?: Object, data?: Object, options: FindOneAndReplaceOption = undefined): Promise<FindAndModifyWriteOpResultObject>\r\n\t{\r\n\t\tMongoCollection.sanitizeQuery(query);\r\n\t\tlet collection = this.getSchema().collection();\r\n\t\treturn collection.findOneAndUpdate(query, {\r\n\t\t\t$set: data\r\n\t\t}, options).then( result => {\r\n\t\t\tif(options && options.returnOriginal)\r\n\t\t\t{\r\n\t\t\t\treturn result.value;\r\n\t\t\t}\r\n\t\t\treturn result;\r\n\t\t}).catch( error => {\r\n\t\t\treturn error;\r\n\t\t})\r\n\t}\r\n\r\n\tstatic updateOne<T extends MongoCollection>(query?: Object, data?: Object, options: ReplaceOneOptions = undefined): Promise<UpdateWriteOpResult>\r\n\t{\r\n\t\tMongoCollection.sanitizeQuery(query);\r\n\t\tlet collection = this.getSchema().collection();\r\n\t\treturn collection.updateOne(query, {\r\n\t\t\t$set: data\r\n\t\t}, options);\r\n\t}\r\n\r\n\tstatic update<T extends MongoCollection>(query?: Object, data?: Object, options: ReplaceOneOptions & { multi?: boolean } = undefined): Promise<WriteOpResult>\r\n\t{\r\n\t\tMongoCollection.sanitizeQuery(query);\r\n\t\tlet collection = this.getSchema().collection();\r\n\t\treturn collection.update(query, {\r\n\t\t\t$set: data\r\n\t\t}, options);\r\n\t}\r\n\r\n\tstatic remove(query: Object): Promise<WriteOpResult>\r\n\t{\r\n\t\tMongoCollection.sanitizeQuery(query);\r\n\t\tlet  collection = this.getSchema().collection();\r\n\t\treturn collection.remove(query);\r\n\t}\r\n\r\n\tstatic removeOne(query: Object): Promise<WriteOpResult>\r\n\t{\r\n\t\tMongoCollection.sanitizeQuery(query);\r\n\t\tlet  collection = this.getSchema().collection();\r\n\t\treturn collection.remove(query, {single: true});\r\n\t}\r\n\r\n\tstatic aggregate<T extends MongoCollection>(pipeline:any[] = []): AggregationCursor<T>\r\n\t{\r\n\t\treturn this.getCollection().aggregate(pipeline);\r\n\t}\r\n\r\n\tstatic getSchema(): MongoSchema\r\n\t{\r\n\t\treturn MongoSchemaRegistry.getSchema(this.name);\r\n\t}\r\n\r\n\tstatic getCollection(): Collection<any>\r\n\t{\r\n\t\treturn this.getSchema().collection();\r\n\t}\r\n\r\n\tstatic stats(): Promise<CollStats>\r\n\t{\r\n\t\treturn this.getCollection().stats();\r\n\t}\r\n\r\n\tcollection(): Collection<any>\r\n\t{\r\n\t\treturn this.getSchemaDefinition().collection();\r\n\t}\r\n\r\n\tgetSchemaDefinition(): MongoSchema\r\n\t{\r\n\t\treturn MongoSchemaRegistry.getSchema(this.constructor.name);\r\n\t\t//return (<any>this.constructor).SchemaDefinition;\r\n\t}\r\n\r\n\tsave(options: any = {}): Promise<any>\r\n\t{\r\n\t\tif(!this._id)\r\n\t\t{\r\n\t\t\treturn this.insert(options);\r\n\t\t}else{\r\n\t\t\treturn this.update(options);\r\n\t\t}\r\n\t}\r\n\r\n\tinsert(options: CollectionInsertOneOptions = undefined): Promise<this>\r\n\t{\r\n\t\tlet schema = this.getSchemaDefinition();\r\n\t\tlet collection = schema.collection();\r\n\t\tlet data = this.toObject();\r\n\t\tlet validationResult = schema.validate(data);\r\n\t\tif(!validationResult)\r\n\t\t{\r\n\t\t\treturn collection.insertOne(data, options).then( result => {\r\n\t\t\t\tthis._id = result.insertedId; // Assign inserted _id\r\n\t\t\t\tconsole.log(\"New insertedId:\", this._id);\r\n\t\t\t\treturn this;\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn Promise.reject(validationResult);\r\n\t}\r\n\t\r\n\tupdate(options: ReplaceOneOptions = undefined): Promise<this>\r\n\t{\r\n\t\tlet schema = this.getSchemaDefinition();\r\n\t\tlet collection = schema.collection();\r\n\t\tlet data = this.toObject();\r\n\t\tlet validationResult = schema.validate(data);\r\n\t\tif(!validationResult)\r\n\t\t{\r\n\t\t\treturn collection.updateOne({\r\n\t\t\t\t_id: this._id,\r\n\t\t\t}, {\r\n\t\t\t\t$set: data\r\n\t\t\t}, options).then( result => {\r\n\t\t\t\treturn this;\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn Promise.reject(validationResult);\r\n\t}\r\n\t\r\n\tremove(): Promise<any>\r\n\t{\r\n\t\tif(!this._id)\r\n\t\t{\r\n\t\t\treturn Promise.reject(\"_id is not defined\");\r\n\t\t}\r\n\r\n\t\treturn this.collection().deleteOne({\r\n\t\t\t_id: this._id\r\n\t\t});\r\n\t}\r\n\r\n\treplace(replaceWith: MongoCollection): Promise<WriteOpResult>\r\n\t{\r\n\t\tlet schema = replaceWith.getSchemaDefinition();\r\n\t\tlet collection = schema.collection();\r\n\t\tlet data = replaceWith.toObject();\r\n\t\tlet validationResult = schema.validate(data);\r\n\t\tif(!validationResult)\r\n\t\t{\r\n\t\t\treturn this.collection().replaceOne({ _id: this._id }, data);\r\n\t\t}\r\n\t\treturn Promise.reject(validationResult);\r\n\t}\r\n};"]}